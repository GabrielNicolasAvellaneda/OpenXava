<?xml version="1.0"?>
<tl>
<declare import="org.openxava.util.Primitives"/>
<declare import="org.openxava.util.Strings"/>
<declare import="org.openxava.util.XavaException"/>
<declare import="org.openxava.util.meta.MetaSet"/>
<declare import="org.openxava.component.MetaComponent"/>
<declare import="org.openxava.model.meta.*"/>
<declare import="org.openxava.calculators.*"/>
<declare import="org.openxava.generators.*"/>
<declare import="org.openxava.mapping.*"/>


<java>
String packageName = properties.getProperty("arg3");
String componentName = properties.getProperty("arg4");
String aggregateName = properties.getProperty("arg5");
MetaComponent component = MetaComponent.get(componentName);

String name=null;
IMetaModel metaModel=null;
if (aggregateName == null) {
	name=componentName;	
	metaModel = (IMetaModel) component.getMetaEntity();
}
else {
	name=aggregateName;	
	metaModel =  (IMetaEjb)component.getMetaAggregate(aggregateName);
}


</java>
// File generated by OpenXava: <expr>new Date()</expr>
// Archivo generado por OpenXava: <expr>new Date()</expr>

// WARNING: NO EDIT
// OJO: NO EDITAR


<java>if (aggregateName == null) { </java>
// Component: <expr>componentName</expr>		Entity/Entidad
<java>} else { </java>
// Component: <expr>componentName</expr>		Aggregate/Agregado: <expr>aggregateName</expr>
<java>} </java>

package <expr>packageName</expr>;

import java.util.*;
import java.math.*;
import java.rmi.RemoteException;
import org.openxava.component.MetaComponent;
import org.openxava.model.meta.MetaModel;
import org.openxava.util.*;

/**
 * 
 * @author MCarmen Gimeno
 */
public class <expr>name</expr> implements java.io.Serializable, <expr>metaModel.getInterfaceName()</expr> {	

	// Constructor
	public <expr>name</expr>() {
		initMembers();
	}
	
	<java>InitMembersPG.generate(context, out, metaModel, false); </java> 
	
	// Properties/Propiedades
	
<java>
Iterator itProperties = metaModel.getMetaProperties().iterator();	
while (itProperties.hasNext()) {	
	MetaProperty property = (MetaProperty) itProperties.next();
	PropertyPG.generate(context, out, property); 
}
</java> 

	// References/Referencias
	
<java>
Iterator itReferences = metaModel.getMetaReferences().iterator();	
while (itReferences.hasNext()) {	
	MetaReference ref = (MetaReference) itReferences.next();
	if (ref.getMetaModelReferenced() instanceof MetaAggregateBean) {
		AggregateReferencePG.generate(context, out, ref); 
	}
	else {
		EntityReferencePG.generate(context, out, ref); 
	}
}
</java> 

	// Colecciones/Collections
	
<java>
Iterator itCollections = metaModel.getMetaCollections().iterator();	
while (itCollections.hasNext()) {	
	MetaCollection col = (MetaCollection) itCollections.next();
	String colName = Strings.firstUpper(col.getName());
	MetaReference reference = col.getMetaReference();
	String colType = reference.getMetaModelReferenced().getInterfaceName();
	String roleName = Strings.firstUpper(reference.getRole());
	if (!col.hasCondition() &amp;&amp; !col.hasCalculator()) {
</java> 
	private java.util.Collection <expr>col.getName()</expr>;
	public java.util.Collection get<expr>colName</expr>() {
		return <expr>col.getName()</expr>;
	}
	public void set<expr>colName</expr>(java.util.Collection <expr>col.getName()</expr>) {
		this.<expr>col.getName()</expr> = <expr>col.getName()</expr>;
	}
<java>
	}
	if (col.hasCondition()) {
</java> 
	public java.util.Collection get<expr>colName</expr>() throws RemoteException {
		org.hibernate.Query query = org.openxava.hibernate.XHibernate.getSession().createQuery("<expr>col.getHQLCondition()</expr>");		
<java>
		int i=0;
		for (Iterator it = col.getMetaPropertiesFinderArguments(true).iterator(); it.hasNext(); i++) {
			MetaProperty parameter = (MetaProperty) it.next();
			String argument = Generators.convertPropertyNameInPropertyCall(parameter.getName());
			if (parameter.getType().isPrimitive()) {
				argument = Generators.generatePrimitiveWrapper(parameter.getTypeName(), argument);
			}
</java>
		query.setParameter(<expr>i</expr>, <expr>argument</expr>);
<java>		
		}
</java> 
		return query.list();
	}	
<java>
	}
	else if (col.hasCalculator()) {
		CalculatedCollectionPG.generate(context, out, col);	
	}
	if (!reference.isAggregate() &amp;&amp; 
		!col.hasCondition() &amp;&amp; 
		!col.hasCalculator() &amp;&amp; 
		!reference.getMetaModelReferenced().getMetaReference(reference.getRole()).isKey()) { 
</java> 
	
	public void addTo<expr>colName</expr>(<expr>colType</expr> newElement) throws RemoteException {
		this.get<expr>colName</expr>().add(newElement);
		newElement.set<expr>roleName</expr>(this);
	}
	public void removeFrom<expr>colName</expr>(<expr>colType</expr> toRemove) throws RemoteException {
		this.get<expr>colName</expr>().remove(toRemove);
		toRemove.set<expr>roleName</expr>(null);
	}
<java>
	}
</java> 

<java>
}
</java> 

<java>	
	MethodsPG.generate(context, out, metaModel); 
</java> 	

	// User defined finders/Buscadores definidos por el usuario
	
	
<java>

 Iterator itFinders = metaModel.getMetaFinders().iterator();
 while (itFinders.hasNext()) {
 	MetaFinder finder = (MetaFinder) itFinders.next();
 	String finderName = Strings.firstUpper(finder.getName());
 	String arguments = finder.getArguments();
 	String condition = finder.getEJBQLCondition(); 	
 	String type = finder.isCollection()?"Collection":name;
 	String result = finder.isCollection()?"new org.openxava.hibernate.impl.FastSizeList(query, sizeQuery)":"(" + name + ") query.uniqueResult()";
</java> 	
 	public static <expr>type</expr> find<expr>finderName</expr>(<expr>arguments</expr>) {
 		org.hibernate.Query query = org.openxava.hibernate.XHibernate.getSession().createQuery("<expr>finder.getHQLCondition()</expr>");
 		<java>if (finder.isCollection()) { </java> 
 		org.hibernate.Query sizeQuery = org.openxava.hibernate.XHibernate.getSession().createQuery("select count(*) <expr>finder.getHQLCondition()</expr>");
 		<java>} </java>
<java>
		int i=0;
		for (Iterator it = finder.getMetaPropertiesArguments().iterator(); it.hasNext(); i++) {
			MetaProperty parameter = (MetaProperty) it.next();
			String argument = parameter.getName();
			if (parameter.getType().isPrimitive()) {
				argument = Generators.generatePrimitiveWrapper(parameter.getTypeName(), argument);
			}
</java> 
		query.setParameter("arg<expr>i</expr>", <expr>argument</expr>);
			<java>if (finder.isCollection()) { </java> 
		sizeQuery.setParameter("arg<expr>i</expr>", <expr>argument</expr>);
			<java>} </java> 
<java>
		}
</java> 
 		return <expr>result</expr>;
 	}
 	
<java>
 }
</java> 


	private MetaModel metaModel;
	public MetaModel getMetaModel() throws XavaException {
		if (metaModel == null) {
		<java>if (aggregateName == null) { </java>
			metaModel = MetaComponent.get("<expr>componentName</expr>").getMetaEntity();
		<java>} else { </java> 
			metaModel = MetaComponent.get("<expr>componentName</expr>").getMetaAggregate("<expr>aggregateName</expr>");
		<java>} </java> 	
		}
		return metaModel;
	}
	
	public String toString() {		
		StringBuffer toStringValue = new StringBuffer("[.");
		java.lang.reflect.Field [] fields = getClass().getDeclaredFields();
		Arrays.sort(fields, FieldComparator.getInstance());
		for (int i=0; i &lt; fields.length; i++) {
			try {
				if (getMetaModel().isKey(fields[i].getName())) {
					toStringValue.append(fields[i].get(this)).append('.');
				}
			}
			catch (Exception ex) {
				ex.printStackTrace();
				toStringValue.append(" ").append('.');
			}
		}
		toStringValue.append(']');
		return toStringValue.toString();
	}

	public boolean equals(Object other) {		
		if (other == null) return false;
		return toString().equals(other.toString());
	}
	
	public int hashCode() {		
		return toString().hashCode();
	}
	
}

</tl>